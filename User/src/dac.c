#include "ch32v30x.h"

uint16_t Sine_Buf[500] = {
        2048,2073,2099,2125,2150,2176,2202,2227,2253,2279,2304,2330,2355,2380,
        2406,2431,2456,2482,2507,2532,2557,2582,2606,2631,2656,2680,2705,2729,2753,
        2777,2801,2825,2849,2872,2896,2919,2942,2966,2988,3011,3034,3056,3079,3101,
        3123,3145,3166,3188,3209,3230,3251,3272,3292,3313,3333,3353,3372,3392,3411,
        3430,3449,3468,3486,3504,3522,3540,3558,3575,3592,3609,3625,3641,3657,3673,
        3689,3704,3719,3734,3748,3762,3776,3790,3803,3816,3829,3842,3854,3866,3878,
        3889,3900,3911,3921,3932,3942,3951,3961,3970,3978,3987,3995,4003,4010,4017,
        4024,4031,4037,4043,4048,4054,4059,4063,4068,4072,4075,4079,4082,4085,4087,
        4089,4091,4092,4094,4094,4095,4095,4095,4094,4094,4092,4091,4089,4087,4085,
        4082,4079,4075,4072,4068,4063,4059,4054,4048,4043,4037,4031,4024,4017,4010,
        4003,3995,3987,3978,3970,3961,3951,3942,3932,3921,3911,3900,3889,3878,3866,
        3854,3842,3829,3816,3803,3790,3776,3762,3748,3734,3719,3704,3689,3673,3657,
        3641,3625,3609,3592,3575,3558,3540,3522,3504,3486,3468,3449,3430,3411,3392,
        3372,3353,3333,3313,3292,3272,3251,3230,3209,3188,3166,3145,3123,3101,3079,
        3056,3034,3011,2988,2966,2943,2919,2896,2872,2849,2825,2801,2777,2753,2729,
        2705,2680,2656,2631,2606,2582,2557,2532,2507,2482,2456,2431,2406,2381,2355,
        2330,2304,2279,2253,2227,2202,2176,2150,2125,2099,2073,2048,2022,1996,1970,
        1945,1919,1893,1868,1842,1816,1791,1765,1740,1715,1689,1664,1639,1613,1588,
        1563,1538,1513,1489,1464,1439,1415,1390,1366,1342,1318,1294,1270,1246,1223,
        1199,1176,1153,1129,1107,1084,1061,1039,1016,994,972,950,929,907,886,865,
        844,823,803,782,762,742,723,703,684,665,646,627,609,591,573,555,537,520,
        503,486,470,454,438,422,406,391,376,361,347,333,319,305,292,279,266,253,
        241,229,217,206,195,184,174,163,153,144,134,125,117,108,100,92,85,78,71,
        64,58,52,47,41,36,32,27,23,20,16,13,10,8,6,4,3,1,1,0,0,0,1,1,3,4,6,8,10,
        13,16,20,23,27,32,36,41,47,52,58,64,71,78,85,92,100,108,117,125,134,144,
        153,163,174,184,195,206,217,229,241,253,266,279,292,305,319,333,347,361,
        376,391,406,422,438,454,470,486,503,520,537,555,573,591,609,627,646,665,
        684,703,723,742,762,782,803,823,844,865,886,907,929,950,972,994,1016,1039,
        1061,1084,1107,1129,1153,1176,1199,1223,1246,1270,1294,1318,1342,1366,1390,
        1415,1439,1464,1489,1513,1538,1563,1588,1613,1639,1664,1689,1715,1740,1765,
        1791,1816,1842,1868,1893,1919,1945,1970,1996,2022

};

void DAC_DMA_Config() {
    RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA2, ENABLE);
    DMA_InitTypeDef DMA_InitStructer;

    DMA_DeInit(DMA2_Channel3);

    DMA_InitStructer.DMA_BufferSize = 500;
    DMA_InitStructer.DMA_DIR = DMA_DIR_PeripheralDST; //DMA direction:peripheral to memory
    DMA_InitStructer.DMA_M2M = DMA_M2M_Disable;
    DMA_InitStructer.DMA_MemoryBaseAddr = (uint32_t) Sine_Buf;
    DMA_InitStructer.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
    DMA_InitStructer.DMA_MemoryInc = DMA_MemoryInc_Enable;
    DMA_InitStructer.DMA_Mode = DMA_Mode_Circular;
    DMA_InitStructer.DMA_PeripheralBaseAddr = (uint32_t) &(DAC->R12BDHR1);
    DMA_InitStructer.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;
    DMA_InitStructer.DMA_PeripheralInc = DMA_PeripheralInc_Disable;
    DMA_InitStructer.DMA_Priority = DMA_Priority_High;
    DMA_Init(DMA2_Channel3, &DMA_InitStructer);

    DMA_Cmd(DMA2_Channel3, ENABLE);
}

void DAC_Config()
{
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
    GPIO_InitTypeDef GPIO_Initstructure;
    GPIO_Initstructure.GPIO_Mode=GPIO_Mode_AIN;
    GPIO_Initstructure.GPIO_Pin=GPIO_Pin_4;
    GPIO_Initstructure.GPIO_Speed=GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &GPIO_Initstructure);
    GPIO_SetBits(GPIOA, GPIO_Pin_4);


    RCC_APB1PeriphClockCmd(RCC_APB1Periph_DAC, ENABLE);
    DAC_InitTypeDef DAC_InitStructure;
    //DAC_InitStructure.DAC_LFSRUnmask_TriangleAmplitude=DAC_TriangleAmplitude_4095;
    DAC_InitStructure.DAC_OutputBuffer=DAC_OutputBuffer_Enable;
    DAC_InitStructure.DAC_Trigger=DAC_Trigger_T8_TRGO;
    DAC_InitStructure.DAC_WaveGeneration=DAC_WaveGeneration_None;

    DAC_DMA_Config();
    DAC_Init(DAC_Channel_1,&DAC_InitStructure);
    DAC_Cmd(DAC_Channel_1, ENABLE);
    DAC_DMACmd(DAC_Channel_1, ENABLE);
}
